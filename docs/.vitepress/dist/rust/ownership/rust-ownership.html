<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rsut 所有权机制 | My blog</title>
    <meta name="description" content="这是一个记录个人工作生活的博客">
    <meta name="generator" content="VitePress v1.3.0">
    <link rel="preload stylesheet" href="/free-blog/assets/style.CO_Tb4_a.css" as="style">
    
    <script type="module" src="/free-blog/assets/app.BqccpReU.js"></script>
    <link rel="preload" href="/free-blog/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/free-blog/assets/chunks/framework.BBCWOUBu.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/theme.DGeli2J_.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/katex.CvgdMzdh.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/c4Diagram-ae766693.C5ySOfib.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/flowDiagram-b222e15a.lLlE2kI5.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/flowDiagram-v2-13329dc7.CZUYj1MK.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/erDiagram-09d1c15f.B5PgTqIf.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/gitGraphDiagram-942e62fe.BXbLY24i.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/ganttDiagram-b62c793e.BlKNf-T4.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/infoDiagram-94cd232f.C_9QMLQs.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/pieDiagram-bb1d19e5.BICB1Na-.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/quadrantDiagram-c759a472.Dq4B5e45.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/xychartDiagram-f11f50a6.DfcRiFGw.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/requirementDiagram-87253d64.CGQQKMqY.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/sequenceDiagram-6894f283.6QQiCu0u.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/classDiagram-fb54d2a0.B4tPKqVM.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/classDiagram-v2-a2b738ad.BcGXIsCr.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/stateDiagram-5dee940d.Dm1FhicX.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/stateDiagram-v2-1992cada.CQ1VWCzJ.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/journeyDiagram-6625b456.PoMISOMb.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/flowchart-elk-definition-ae0efee6.54QHI0Wj.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/timeline-definition-bf702344.CNMoY4ly.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/mindmap-definition-307c710a.B4uwS-Fe.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/sankeyDiagram-707fac0f.BXn_dtwZ.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/blockDiagram-9f4a6865.DgcPbLs9.js">
    <link rel="modulepreload" href="/free-blog/assets/chunks/virtual_mermaid-config.DDnGl6nM.js">
    <link rel="modulepreload" href="/free-blog/assets/rust_ownership_rust-ownership.md.Dy6NgEI1.lean.js">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M0BGESLHGT"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-M0BGESLHGT");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-c4daae71><!--[--><!--]--><!--[--><span tabindex="-1" data-v-b22defb4></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-b22defb4> Skip to content </a><!--]--><!----><header class="VPNav" data-v-c4daae71 data-v-a46e73f0><div class="VPNavBar has-sidebar top" data-v-a46e73f0 data-v-bb7529ee><div class="wrapper" data-v-bb7529ee><div class="container" data-v-bb7529ee><div class="title" data-v-bb7529ee><div class="VPNavBarTitle has-sidebar" data-v-bb7529ee data-v-dbe614b8><a class="title" href="/free-blog/" data-v-dbe614b8><!--[--><!--]--><!----><span data-v-dbe614b8>My blog</span><!--[--><!--]--></a></div></div><div class="content" data-v-bb7529ee><div class="content-body" data-v-bb7529ee><!--[--><!--]--><div class="VPNavBarSearch search" data-v-bb7529ee><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-bb7529ee data-v-5bacfe89><span id="main-nav-aria-label" class="visually-hidden" data-v-5bacfe89> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/free-blog/" tabindex="0" data-v-5bacfe89 data-v-2b93b872><!--[--><span data-v-2b93b872>主页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/free-blog/work/" tabindex="0" data-v-5bacfe89 data-v-2b93b872><!--[--><span data-v-2b93b872>工作</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/free-blog/rust/" tabindex="0" data-v-5bacfe89 data-v-2b93b872><!--[--><span data-v-2b93b872>Rust</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/free-blog/book/" tabindex="0" data-v-5bacfe89 data-v-2b93b872><!--[--><span data-v-2b93b872>读书笔记</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-bb7529ee data-v-123fcb2f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-123fcb2f data-v-fa1daf57 data-v-7012e5dd><span class="check" data-v-7012e5dd><span class="icon" data-v-7012e5dd><!--[--><span class="vpi-sun sun" data-v-fa1daf57></span><span class="vpi-moon moon" data-v-fa1daf57></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-bb7529ee data-v-08b35e6f data-v-f2234a39><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-f2234a39 data-v-50151957><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-bb7529ee data-v-0c845e5d data-v-8fd20e7d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8fd20e7d><span class="vpi-more-horizontal icon" data-v-8fd20e7d></span></button><div class="menu" data-v-8fd20e7d><div class="VPMenu" data-v-8fd20e7d data-v-39eca401><!----><!--[--><!--[--><!----><div class="group" data-v-0c845e5d><div class="item appearance" data-v-0c845e5d><p class="label" data-v-0c845e5d>Appearance</p><div class="appearance-action" data-v-0c845e5d><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-0c845e5d data-v-fa1daf57 data-v-7012e5dd><span class="check" data-v-7012e5dd><span class="icon" data-v-7012e5dd><!--[--><span class="vpi-sun sun" data-v-fa1daf57></span><span class="vpi-moon moon" data-v-fa1daf57></span><!--]--></span></span></button></div></div></div><div class="group" data-v-0c845e5d><div class="item social-links" data-v-0c845e5d><div class="VPSocialLinks social-links-list" data-v-0c845e5d data-v-f2234a39><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-f2234a39 data-v-50151957><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-bb7529ee data-v-670493dd><span class="container" data-v-670493dd><span class="top" data-v-670493dd></span><span class="middle" data-v-670493dd></span><span class="bottom" data-v-670493dd></span></span></button></div></div></div></div><div class="divider" data-v-bb7529ee><div class="divider-line" data-v-bb7529ee></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-c4daae71 data-v-9d8129cc><div class="container" data-v-9d8129cc><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9d8129cc><span class="vpi-align-left menu-icon" data-v-9d8129cc></span><span class="menu-text" data-v-9d8129cc>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9d8129cc data-v-d1de893e><button data-v-d1de893e>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-c4daae71 data-v-12a40e3d><div class="curtain" data-v-12a40e3d></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-12a40e3d><span class="visually-hidden" id="sidebar-aria-label" data-v-12a40e3d> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-ec086cd5><section class="VPSidebarItem level-0 has-active" data-v-ec086cd5 data-v-10acf738><div class="item" role="button" tabindex="0" data-v-10acf738><div class="indicator" data-v-10acf738></div><h2 class="text" data-v-10acf738>Rust</h2><!----></div><div class="items" data-v-10acf738><!--[--><section class="VPSidebarItem level-1 is-link" data-v-10acf738 data-v-10acf738><div class="item" tabindex="0" data-v-10acf738><div class="indicator" data-v-10acf738></div><a class="VPLink link link" href="/free-blog/rust/error/" data-v-10acf738><!--[--><h3 class="text" data-v-10acf738>错误处理</h3><!--]--></a><!----></div><div class="items" data-v-10acf738><!--[--><div class="VPSidebarItem level-2 is-link" data-v-10acf738 data-v-10acf738><div class="item" data-v-10acf738><div class="indicator" data-v-10acf738></div><a class="VPLink link link" href="/free-blog/rust/error/panic.html" data-v-10acf738><!--[--><p class="text" data-v-10acf738>什么是panic？</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 is-link has-active" data-v-10acf738 data-v-10acf738><div class="item" tabindex="0" data-v-10acf738><div class="indicator" data-v-10acf738></div><a class="VPLink link link" href="/free-blog/rust/ownership/" data-v-10acf738><!--[--><h3 class="text" data-v-10acf738>所有权机制</h3><!--]--></a><!----></div><div class="items" data-v-10acf738><!--[--><div class="VPSidebarItem level-2 is-link" data-v-10acf738 data-v-10acf738><div class="item" data-v-10acf738><div class="indicator" data-v-10acf738></div><a class="VPLink link link" href="/free-blog/rust/ownership/rust-ownership.html" data-v-10acf738><!--[--><p class="text" data-v-10acf738>什么是所有权？</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-c4daae71 data-v-d2aef184><div class="VPDoc has-sidebar has-aside" data-v-d2aef184 data-v-ef3a4dda><!--[--><!--]--><div class="container" data-v-ef3a4dda><div class="aside" data-v-ef3a4dda><div class="aside-curtain" data-v-ef3a4dda></div><div class="aside-container" data-v-ef3a4dda><div class="aside-content" data-v-ef3a4dda><div class="VPDocAside" data-v-ef3a4dda data-v-79cae1a0><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-79cae1a0 data-v-dfbd9fb8><div class="content" data-v-dfbd9fb8><div class="outline-marker" data-v-dfbd9fb8></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-dfbd9fb8>On this page</div><ul class="VPDocOutlineItem root" data-v-dfbd9fb8 data-v-da421f78><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-79cae1a0></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-ef3a4dda><div class="content-container" data-v-ef3a4dda><!--[--><!--]--><main class="main" data-v-ef3a4dda><div style="position:relative;" class="vp-doc _free-blog_rust_ownership_rust-ownership" data-v-ef3a4dda><div><h1 id="rsut-所有权机制" tabindex="-1">Rsut 所有权机制 <a class="header-anchor" href="#rsut-所有权机制" aria-label="Permalink to &quot;Rsut 所有权机制&quot;">​</a></h1><p>所有权是Rsut中最独特的特性，它让Rust无需GC就可以保证内存安全。</p><h2 id="什么是所有权" tabindex="-1">什么是所有权？ <a class="header-anchor" href="#什么是所有权" aria-label="Permalink to &quot;什么是所有权？&quot;">​</a></h2><p><strong>所有权</strong>（<em>ownership</em>）是 Rust 用于如何管理内存的一组规则。所有程序都必须管理其运行时使用计算机内存的方式。一些语言中具有垃圾回收机制，在程序运行时有规律地寻找不再使用的内存；在另一些语言中，程序员必须亲自分配和释放内存。<strong>Rust 则选择了第三种方式：通过所有权系统管理内存，编译器在编译时会根据一系列的规则进行检查。如果违反了任何这些规则，程序都不能编译。在运行时，所有权系统的任何功能都不会减慢程序。</strong></p><p>摘自：<a href="https://kaisery.github.io/trpl-zh-cn/ch04-01-what-is-ownership.html#%E4%BB%80%E4%B9%88%E6%98%AF%E6%89%80%E6%9C%89%E6%9D%83" target="_blank" rel="noreferrer">什么是所有权</a></p><h3 id="栈内存和堆内存-stack-vs-heap" tabindex="-1">栈内存和堆内存（Stack vs Heap） <a class="header-anchor" href="#栈内存和堆内存-stack-vs-heap" aria-label="Permalink to &quot;栈内存和堆内存（Stack vs Heap）&quot;">​</a></h3><p>在Rust语言中，一个值在栈内存还是堆内存，对语言的行为和编码时要为此做的操作有更大的影响。</p><p>栈和堆都是代码在运行时可供使用的内存，但是它们的结构不同。栈以放入值的顺序存储值并以相反顺序取出值。这也被称作 <strong>后进先出</strong>（<em>last in, first out</em>）。</p><p>增加数据叫做 <strong>进栈</strong>（<em>pushing onto the stack</em>），而移出数据叫做 <strong>出栈</strong>（<em>popping off the stack</em>）。栈中的所有数据都必须占用已知且固定的大小。在编译时大小未知或大小可能变化的数据，要改为存储在堆上。 堆是缺乏组织的：当向堆放入数据时，你要请求一定大小的空间。内存分配器（memory allocator）在堆的某处找到一块足够大的空位，把它标记为已使用，并返回一个表示该位置地址的 <strong>指针</strong>（<em>pointer</em>）。这个过程称作 <strong>在堆上分配内存</strong>（<em>allocating on the heap</em>），有时简称为 “分配”（allocating）。</p><h3 id="所有权规则" tabindex="-1">所有权规则 <a class="header-anchor" href="#所有权规则" aria-label="Permalink to &quot;所有权规则&quot;">​</a></h3><ol><li>Rust 中的每一个值都有一个 <strong>所有者</strong>（<em>owner</em>）。</li><li>值在任一时刻有且只有一个所有者。</li><li>当所有者（变量）离开作用域，这个值将被丢弃。</li></ol><h3 id="变量的作用域" tabindex="-1">变量的作用域 <a class="header-anchor" href="#变量的作用域" aria-label="Permalink to &quot;变量的作用域&quot;">​</a></h3><p>字符串字面值是被硬编码进程序里的字符串值，不可变，存储在栈当中，并且当离开作用域时被移出栈。String类型存储在堆当中，可变，所以在这里更适合用来讨论所有权机制以及变量作用域的情况。</p><p><strong>Rust释放无用内存的策略：内存在拥有它的变量离开作用域后就被自动释放。</strong></p><p>使用大括号可以自定义变量的作用域范围，以下分别是字符串字面值和String类型的关于作用域的示例：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 字符串字面值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{                      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s 在这里无效，它尚未声明</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从此处起，s 是有效的</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 使用 s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}                      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 此作用域已结束，s 不再有效</span></span></code></pre></div><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// String 类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 从此处起，s 是有效的</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 使用 s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}                                  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 此作用域已结束，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                   // s 不再有效</span></span></code></pre></div><h3 id="string类型" tabindex="-1">String类型 <a class="header-anchor" href="#string类型" aria-label="Permalink to &quot;String类型&quot;">​</a></h3><p>演示String类型的变量作用域，y和x 指向堆中的同一块内存区域，Rust为了保证内存安全，如果x赋值给了y，就会结束x的作用域，代码示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    let x = String::from(&quot;5&quot;);</span></span>
<span class="line"><span>    let y = x;</span></span>
<span class="line"><span>    println!(&quot;x:{}&quot;, x);</span></span></code></pre></div><p>执行结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>   |</span></span>
<span class="line"><span>11 |     let x = String::from(&quot;5&quot;);</span></span>
<span class="line"><span>   |         - move occurs because `x` has type `String`, which does not implement the `Copy` trait</span></span>
<span class="line"><span>12 |     let y = x;</span></span>
<span class="line"><span>   |             - value moved here</span></span>
<span class="line"><span>13 |     println!(&quot;x:{}&quot;, x);</span></span>
<span class="line"><span>   |                      ^ value borrowed here after move</span></span></code></pre></div><p>两个数据指针指向了同一位置。这就有了一个问题：当 <code>x</code> 和 <code>y</code> 离开作用域，它们都会尝试释放相同的内存。这是一个叫做 <strong>二次释放</strong>（<em>double free</em>）的错误，也是之前提到过的内存安全性 bug 之一。两次释放（相同）内存会导致内存污染，它可能会导致潜在的安全漏洞。</p><p>为了确保内存安全，在 <code>let y = x;</code> 之后，Rust 认为 <code>x</code> 不再有效，因此 Rust 不需要在 <code>x</code> 离开作用域后清理任何东西。此时，只有 <code>s2</code> 是有效的，当其离开作用域，它就释放自己的内存。</p><h3 id="clone" tabindex="-1">clone <a class="header-anchor" href="#clone" aria-label="Permalink to &quot;clone&quot;">​</a></h3><p>如果我们 <strong>确实</strong> 需要深度复制 <code>String</code> 中堆上的数据，而不仅仅是栈上的数据，可以使用一个叫做 <code>clone</code> 的通用函数。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    let x = String::from(&quot;5&quot;);</span></span>
<span class="line"><span>    let y = x.clone();</span></span>
<span class="line"><span>    println!(&quot;x:{}&quot;, x);</span></span></code></pre></div><p>存放在栈上的整形变量，经过移动后，依然有效。因为默认实现了 <code>Copy</code> trait，代码示例：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;x:{}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, x</span></span></code></pre></div><p>执行结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>x:5</span></span></code></pre></div><p>如果一个类型实现了 <code>Copy</code> trait，那么一个旧的变量在将其赋值给其他变量后仍然可用。</p><p>如下是一些 <code>Copy</code> 的类型：</p><ul><li>所有整数类型，比如 <code>u32</code>。</li><li>布尔类型，<code>bool</code>，它的值是 <code>true</code> 和 <code>false</code>。</li><li>所有浮点数类型，比如 <code>f64</code>。</li><li>字符类型，<code>char</code>。</li><li>元组，当且仅当其包含的类型也都实现 <code>Copy</code> 的时候。比如，<code>(i32, i32)</code> 实现了 <code>Copy</code>，但 <code>(i32, String)</code> 就没有。</li></ul><h3 id="所有权与函数" tabindex="-1">所有权与函数 <a class="header-anchor" href="#所有权与函数" aria-label="Permalink to &quot;所有权与函数&quot;">​</a></h3><p>和变量之间进行赋值类似，变量在函数中的移动也会发生作用域的变化，代码示例：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> takes_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(some_string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, some_string);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[cfg(test)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    use</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> super</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    #[test]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test_takes_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        takes_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        println!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;s:{}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 这里发生报错</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>执行 <code>test_takes_ownership()</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>error[E0382]: borrow of moved value: `s`</span></span>
<span class="line"><span>  --&gt; crates/ownership_demo/src/lib.rs:14:26</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>12 |         let s = String::from(&quot;hello&quot;);</span></span>
<span class="line"><span>   |             - move occurs because `s` has type `String`, which does not implement the `Copy` trait</span></span>
<span class="line"><span>13 |         takes_ownership(s);</span></span>
<span class="line"><span>   |                         - value moved here</span></span>
<span class="line"><span>14 |         println!(&quot;s:{}&quot;, s);</span></span>
<span class="line"><span>   |                          ^ value borrowed here after move</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>note: consider changing this parameter type in function `takes_ownership` to borrow instead if owning the value isn&#39;t necessary</span></span>
<span class="line"><span>  --&gt; crates/ownership_demo/src/lib.rs:1:33</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>1  | fn takes_ownership(some_string: String) {</span></span>
<span class="line"><span>   |    ---------------              ^^^^^^ this parameter takes ownership of the value</span></span>
<span class="line"><span>   |    |</span></span>
<span class="line"><span>   |    in this function</span></span>
<span class="line"><span>   = note: this error originates in the macro `$crate::format_args_nl` which comes from the expansion of the macro `println` (in Nightly builds, run with -Z macro-backtrace for more info)</span></span>
<span class="line"><span>help: consider cloning the value if the performance cost is acceptable</span></span>
<span class="line"><span>   |</span></span>
<span class="line"><span>13 |         takes_ownership(s.clone());</span></span>
<span class="line"><span>   |</span></span></code></pre></div><p>当 <code>s</code> 传入到函数当中时，s的作用域就到了函数中，函数后面再获取s将不被允许，发生编译错误，执行也会发生异常。</p><p>但是对于类型是i32类型的参数，情况不同，代码示例如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>fn takes_ownership(some_string: String) {</span></span>
<span class="line"><span>    println!(&quot;{}&quot;, some_string);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>fn takes_ownership_i32(value: i32) {</span></span>
<span class="line"><span>    println!(&quot;{}&quot;, value);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#[cfg(test)]</span></span>
<span class="line"><span>mod tests {</span></span>
<span class="line"><span>    use super::*;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>    #[test]</span></span>
<span class="line"><span>    fn test_takes_ownership() {</span></span>
<span class="line"><span>        let s = String::from(&quot;hello&quot;);</span></span>
<span class="line"><span>        takes_ownership(s);</span></span>
<span class="line"><span>        //println!(&quot;s:{}&quot;, s);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    #[test]</span></span>
<span class="line"><span>    fn test_takes_ownership_i32() {</span></span>
<span class="line"><span>        let value = 12;</span></span>
<span class="line"><span>        takes_ownership_i32(value);</span></span>
<span class="line"><span>        println!(&quot;value:{}&quot;, value);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}</span></span></code></pre></div><p>执行 <code>test_takes_ownership_i32()</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>running 1 test</span></span>
<span class="line"><span>test tests::test_takes_ownership_i32 ... ok</span></span>
<span class="line"><span></span></span>
<span class="line"><span>successes:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>---- tests::test_takes_ownership_i32 stdout ----</span></span>
<span class="line"><span>12</span></span>
<span class="line"><span>value:12</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>successes:</span></span>
<span class="line"><span>    tests::test_takes_ownership_i32</span></span></code></pre></div><p>同理，如果一个类型实现了 <code>Copy</code> trait，那么一个变量在将其传递到函数当中后，函数之后可以再读取该变量。</p><h3 id="返回值与作用域" tabindex="-1">返回值与作用域 <a class="header-anchor" href="#返回值与作用域" aria-label="Permalink to &quot;返回值与作用域&quot;">​</a></h3><p>返回值也可以转移所有权。</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 返回一个String 类型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gives_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> String</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s进入作用域</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s                              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s 返回给调用函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[test]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test_gives_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gives_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s进入作用域</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    takes_ownership</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s作用域移到takes_ownership函数中</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;s:{}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// s 已经被移走，这里会报错  borrow of moved value: `s`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>由此可见，变量在函数调用过程中，作用域会随着函数传入变量，函数返回变量发生变化，无法顺畅的在函数调用后继续使用变量。</p><p>这里就引入了<strong>引用</strong>的概念，可以使用<strong>引用</strong>实现丝滑的使用变量和函数。</p></div></div></main><footer class="VPDocFooter" data-v-ef3a4dda data-v-07d71ff1><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-07d71ff1><span class="visually-hidden" id="doc-footer-aria-label" data-v-07d71ff1>Pager</span><div class="pager" data-v-07d71ff1><a class="VPLink link pager-link prev" href="/free-blog/rust/ownership/" data-v-07d71ff1><!--[--><span class="desc" data-v-07d71ff1>Previous page</span><span class="title" data-v-07d71ff1>所有权机制</span><!--]--></a></div><div class="pager" data-v-07d71ff1><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api-examples.md\":\"DH9rHAOi\",\"apitest.md\":\"CnMtJsNj\",\"book_index.md\":\"D436GbAL\",\"book_microservices-design.md\":\"CuA4XivS\",\"guide_index.md\":\"CTiICCJr\",\"index.md\":\"8F-2k9RU\",\"life_index.md\":\"B_peZPZF\",\"life_my-life.md\":\"ZLH_ZRJK\",\"markdown-examples.md\":\"C_rykiya\",\"rust_error_index.md\":\"B1uTIf0Q\",\"rust_error_panic.md\":\"CrRXe8c3\",\"rust_error_result.md\":\"ByHNz4Qm\",\"rust_index.md\":\"B0JKXnu_\",\"rust_ownership_index.md\":\"CR2glyCh\",\"rust_ownership_rust-ownership.md\":\"Dy6NgEI1\",\"rust_rust-error1.md\":\"Bqe5hdG9\",\"work_ai_index.md\":\"DRArcINA\",\"work_ai_lang-chain-rag.md\":\"NxkR8En4\",\"work_algorithms_index.md\":\"C7ydij7h\",\"work_index.md\":\"BVVaoF92\",\"work_java_docker-nacos-hosname.md\":\"BRnUkKhN\",\"work_java_index.md\":\"bPKTMAaQ\",\"work_java_java-thread-pool.md\":\"BqRAqedn\",\"work_notes_index.md\":\"gUvdtYx3\",\"work_notes_microservices-read.md\":\"D7PbiEmp\",\"work_one.md\":\"NBdVczYf\",\"work_other_docker-nacos-hosname.md\":\"Cf1gRTFj\",\"work_other_index.md\":\"BpXYaAcC\",\"work_spring_index.md\":\"TwVJDIlK\",\"work_spring_spring-circular-dependency.md\":\"Dq4TIj2r\",\"work_two.md\":\"CICX2xkh\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"My blog\",\"description\":\"这是一个记录个人工作生活的博客\",\"base\":\"/free-blog/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"主页\",\"link\":\"/\"},{\"text\":\"工作\",\"link\":\"/work/\"},{\"text\":\"Rust\",\"link\":\"/rust/\"},{\"text\":\"读书笔记\",\"link\":\"/book/\"}],\"sidebar\":{\"/work/\":[{\"text\":\"工作\",\"items\":[{\"text\":\"AI\",\"link\":\"/work/ai/\",\"items\":[{\"text\":\"大模型RAG应用与LangChain4初探\",\"link\":\"/work/ai/lang-chain-rag\"}]},{\"text\":\"Java\",\"link\":\"/work/java/\",\"items\":[{\"text\":\"Java线程池知识点梳理\",\"link\":\"/work/java/java-thread-pool\"},{\"text\":\"Spring Bean循环依赖探究\",\"link\":\"/work/spring/spring-circular-dependency\"}]},{\"text\":\"其他\",\"link\":\"/work/other/\",\"items\":[{\"text\":\"本机运行Nacos容器每次都要重新创建容器，该怎么办？\",\"link\":\"/work/other/docker-nacos-hosname\"}]}]}],\"/life/\":[{\"text\":\"生活\",\"items\":[{\"text\":\"点滴生活\",\"link\":\"/life/my-life\"}]}],\"/book/\":[{\"text\":\"读书笔记\",\"items\":[{\"text\":\"微服务设计\",\"link\":\"/book/microservices-design/\"}]}],\"/rust/\":[{\"text\":\"Rust\",\"items\":[{\"text\":\"错误处理\",\"link\":\"/rust/error/\",\"items\":[{\"text\":\"什么是panic？\",\"link\":\"/rust/error/panic\"}]},{\"text\":\"所有权机制\",\"link\":\"/rust/ownership/\",\"items\":[{\"text\":\"什么是所有权？\",\"link\":\"/rust/ownership/rust-ownership\"}]}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>